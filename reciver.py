#!/usr/bin/python
# coding: utf-8

import paho.mqtt.client as mqtt
import json
import requests

token = "*********"


class decodeErr(Exception):
	pass


def decodeRoom(r):
	if r in {'Living', 'living', u'リビング'}:
		return "Living"
	if r in {'Bedroom', 'bedroom', 'BedRoom', u'ベッドルーム', u'寝室'}:
		return "Bedroom"
	if r in {'Youshitu', 'youshitu','Youshitsu', 'youshitsu', u'洋室'}:
		return "Youshitu"
	print "room decode error"
	raise decodeErr()

def decodeDevice(d):
	if d in {'TV', 'tv', 'Tv', u'テレビ'}:
		return "TV"
	if d in {'Light', 'light', u'ライト', u'あかり', u'灯り', u'電気', u'明かり'}:
		return "Light"
	print "device decode error"
	raise decodeErr()

def decodeAction(a):
	if a in {'Power', 'power', u'電源', u'パワー'}:
		return "Power"
	if a in {'On', 'ON', 'on', u'オン'}:
		return "On"
	if a in {'Off', 'OFF', 'off', u'オフ'}:
		return "Off"
	if a in {'Button', 'button', 'ボタン', u'オン'}:
		return "Button"
	print "action decode error"
	raise decodeErr()

def router(room, device, action):
	if device == "TV" and action in {"On", "Off"}:
		return room + "TVPower"
	if room == "Bedroom" and device == "Light":
		return "BedroomLightButton"
	return room + device + action

def sendAction(record):
	try:
		room = decodeRoom(record['room'])
		device = decodeDevice(record['device'])
		action = decodeAction(record['action'])
		target = router(room, device, action)
	except decodeErr:
		return
	else:
		try:
			ret = requests.post("http://api.beebotte.com/v1/data/publish/IFTTT/ir?token=" + token,
				data=json.dumps({"data":[commandToArray(target)]}),
				headers={"Content-Type":"application/json"}		
			)
		except Exception as ex:
			print "requests err"
			print "    " + r
			print "    " + str(ex)
		print ret.text
		print(commandToArray(target))


def on_connect(client, userdata, flags, respons_code):
    print('status {0}'.format(respons_code))
    client.subscribe("IFTTT/power", 1)

def on_message(client, data, msg):
    print(msg.topic + " " + (msg.payload).decode('utf_8') )
    j = json.loads((msg.payload))
    for r in j['data']:
    	sendAction(r)

def commandToArray(cmd):
	d = {
		"LivingTVPower" : [9056, 4388,  650, 468,  656, 468,  650, 472,  650, 472,  652, 472,  650, 472,  650, 1586,  650, 472,  676, 1560,  650, 1586,  650, 1586,  750, 1488,  646, 1586,  652, 1586,  650, 472,  650, 1586,  650, 472,  676, 1560,  650, 468,  650, 472,  652, 1586,  676, 446,  650, 472,  650, 468,  680, 1562,  652, 466,  656, 1586,  646, 1586,  650, 472,  650, 1588,  650, 1586,  650, 1586,  650, 39674,  9078, 2130,  620],
		"LivingTVVolUp" : [9028, 4410,  656, 468,  630, 492,  630, 494,  630, 494,  628, 494,  628, 488,  630, 1608,  630, 494,  628, 1608,  630, 1608,  650, 1588,  628, 1608,  626, 1608,  630, 1612,  650, 468,  630, 1610,  628, 492,  630, 1608,  628, 494,  624, 1608,  630, 1612,  624, 494,  630, 492,  630, 494,  652, 1586,  630, 494,  626, 1612,  626, 492,  630, 494,  706, 1532,  630, 1608,  630, 1608,  628, 39694,  9032, 2172,  630],
		"LivingTVVolDown" : [9032, 4406,  654, 472,  650, 472,  624, 494,  654, 468,  630, 494,  628, 494,  628, 1608,  650, 472,  650, 1586,  650, 1584,  628, 1612,  626, 1608,  630, 1608,  652, 1586,  630, 492,  650, 1588,  650, 472,  626, 1612,  650, 1586,  626, 1608,  628, 1608,  628, 494,  650, 472,  650, 468,  630, 1608,  630, 494,  630, 494,  650, 472,  652, 470,  652, 1582,  630, 1608,  630, 1608,  630, 39696,  9032, 2202,  620],
		"LivingLightOn" : [9030, 4342,  660, 1552,  686, 420,  686, 446,  660, 446,  684, 1528,  658, 472,  684, 1526,  680, 450,  656, 452,  680, 1528,  684, 1552,  684, 420,  684, 1552,  656, 1558,  680, 1552,  686, 424,  680, 422,  684, 420,  684, 446,  684, 420,  684, 1526,  686, 446,  686, 420,  684, 422,  684, 446,  634, 472,  660, 446,  680, 424,  680, 450,  654, 446,  686, 420,  686, 446,  654, 1552,  684, 426,  654, 446,  684, 446,  658, 446,  660, 446,  660, 472,  634, 472,  656, 450,  654, 450,  680, 450,  630, 476,  656, 450,  654, 452,  654, 478,  628, 476,  654, 450,  654, 450,  656, 1578,  660, 1552,  656, 476,  656, 1558,  654, 1578,  638, 472,  630],
		"LivingLightOff" : [9002, 4368,  634, 1578,  660, 446,  656, 476,  628, 476,  656, 1552,  660, 472,  660, 1552,  654, 476,  628, 476,  654, 1554,  658, 1578,  656, 450,  682, 1552,  658, 1552,  686, 1552,  684, 422,  658, 446,  684, 420,  686, 446,  686, 420,  684, 1528,  684, 446,  684, 422,  658, 446,  660, 472,  634, 472,  684, 420,  684, 420,  660, 472,  660, 446,  660, 446,  660, 472,  634, 472,  684, 1528,  654, 450,  680, 452,  680, 426,  680, 424,  680, 450,  656, 446,  686, 420,  684, 420,  686, 446,  634, 472,  660, 446,  660, 446,  680, 450,  654, 450,  682, 1526,  684, 1554,  684, 1528,  684, 1554,  660, 446,  654, 1584,  658, 1548,  684, 426,  680],
		"YoushituLightOn" : [9050, 4440,  660, 472,  654, 1604,  654, 476,  630, 498,  634, 498,  654, 476,  654, 476,  654, 1600,  660, 1600,  634, 498,  634, 1626,  634, 1626,  654, 472,  660, 1600,  658, 1600,  654, 476,  654, 472,  634, 1626,  654, 1604,  656, 470,  660, 470,  656, 1604,  654, 476,  654, 1604,  634, 1620,  634, 498,  634, 496,  656, 1600,  660, 1600,  634, 496,  634, 1626,  634, 498,  630, 41322,  9126, 2112,  684],
		"YoushituLightOff" : [9048, 4440,  684, 446,  634, 1624,  634, 498,  634, 496,  654, 472,  658, 472,  634, 496,  656, 1602,  656, 1602,  656, 476,  630, 1630,  628, 1628,  656, 472,  660, 1600,  634, 1626,  634, 470,  680, 476,  634, 1624,  634, 1626,  654, 1604,  656, 1604,  654, 1604,  630, 496,  634, 1626,  634, 1624,  656, 476,  656, 476,  630, 446,  684, 498,  654, 476,  654, 1604,  654, 476,  630, 41340,  9048, 2222,  630],
		"BedroomLightButton" : [10334, 5024,  726, 1852,  726, 1852,  726, 1852,  726, 578,  726, 566,  726, 1852,  730, 1852,  726, 1862,  726, 564,  726, 568,  752, 1826,  726, 1860,  726, 570,  752, 538,  752, 544,  752, 548,  752, 1826,  854, 1724,  726, 1852,  730, 574,  726, 566,  730, 548,  768, 540,  752, 1838,  726, 564,  752, 540,  756, 538,  752, 1836,  752, 1826,  726, 1852,  730, 1852,  726, 564,  722, 45844,  10334, 2458,  722],                               
		"BedroomTVPower" : [9022, 4404,  634, 502,  632, 502,  630, 502,  632, 502,  630, 1612,  632, 502,  630, 1608,  634, 502,  654, 1586,  634, 1608,  634, 1608,  634, 1608,  634, 502,  630, 1612,  630, 502,  656, 1586,  634, 1608,  634, 1608,  634, 1608,  634, 502,  634, 1608,  632, 502,  628, 502,  634, 502,  634, 502,  630, 502,  634, 502,  630, 1612,  630, 502,  634, 1608,  634, 1608,  634, 1608,  634, 39360,  9020, 2164,  634],
		"BedroomTVVolUp" : [9070, 4358,  680, 450,  656, 480,  656, 480,  654, 476,  654, 1586,  680, 454,  656, 1582,  660, 476,  656, 1586,  680, 1562,  654, 1588,  680, 1562,  654, 480,  680, 1556,  684, 450,  656, 1586,  680, 454,  680, 1562,  680, 450,  656, 480,  680, 1560,  680, 454,  656, 476,  656, 480,  680, 1556,  660, 476,  654, 1586,  656, 1586,  654, 480,  654, 1582,  658, 1584,  658, 1582,  660, 39334,  9046, 2138,  680],
		"BedroomTVVolDown" : [9042, 4384,  654, 480,  628, 502,  654, 480,  654, 476,  654, 1586,  634, 502,  654, 1588,  654, 480,  654, 1582,  660, 1582,  660, 1582,  634, 1608,  660, 476,  654, 1586,  656, 480,  654, 1584,  658, 1582,  658, 476,  654, 1586,  656, 480,  654, 1586,  656, 476,  656, 480,  656, 476,  656, 480,  654, 1586,  656, 480,  650, 1586,  654, 480,  656, 1588,  654, 1586,  656, 1586,  654, 39338,  9044, 2138,  654],
	}
	ar = {"code":d[cmd],"cmd":cmd}
	return ar




client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.username_pw_set("token:" + token)
client.connect("mqtt.beebotte.com", 1883, 60)

client.loop_forever()
